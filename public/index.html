<title>HgaaS - Mercury as a Service</title>

<link rel="stylesheet" href="lib/codemirror.css" />
<link rel="stylesheet" href="lib/solarized.css" />
<script src="lib/codemirror.js"></script>
<script src="mode/meta.js"></script>
<script src="mode/xml/xml.js"></script>
<script src="mode/ruby/ruby.js"></script>
<script src="mode/javascript/javascript.js"></script>
<script src="mode/rst/rst.js"></script>
<script src="mode/tiddlywiki/tiddlywiki.js"></script>
<script src="mode/haskell/haskell.js"></script>
<script src="mode/erlang/erlang.js"></script>
<script src="mode/smalltalk/smalltalk.js"></script>
<script src="mode/pig/pig.js"></script>
<script src="mode/php/php.js"></script>
<script src="mode/diff/diff.js"></script>
<script src="mode/jinja2/jinja2.js"></script>
<script src="mode/markdown/markdown.js"></script>
<script src="mode/python/python.js"></script>
<script src="mode/properties/properties.js"></script>
<script src="mode/verilog/verilog.js"></script>
<script src="mode/sql/sql.js"></script>
<script src="mode/http/http.js"></script>
<script src="mode/shell/shell.js"></script>
<script src="mode/vbscript/vbscript.js"></script>
<script src="mode/coffeescript/coffeescript.js"></script>
<script src="mode/perl/perl.js"></script>
<script src="mode/yaml/yaml.js"></script>
<script src="mode/htmlmixed/htmlmixed.js"></script>
<script src="mode/css/css.js"></script>
<script src="mode/r/r.js"></script>
<script src="mode/clike/clike.js"></script>
<script src="mode/scheme/scheme.js"></script>
<script src="mode/sass/sass.js"></script>
<script src="mode/go/go.js"></script>
<!-- <script src='mode/rust/rust.js'></script> -->
<script src="mode/xquery/xquery.js"></script>
<script src="mode/sparql/sparql.js"></script>
<script src="mode/htmlembedded/htmlembedded.js"></script>

<script type="text/javascript" src="jquery-3.6.1.min.js"></script>
<div id="logsPanel">
	<section id="log">
	  <pre>
	Tue Nov 15 17:44:26 PST 2022
	Tue Nov 15 17:44:27 PST 2022
	Tue Nov 15 17:44:28 PST 2022
	Tue Nov 15 17:44:29 PST 2022
	Tue Nov 15 17:44:30 PST 2022
	Tue Nov 15 17:44:31 PST 2022
	Tue Nov 15 17:44:32 PST 2022
	Tue Nov 15 17:44:33 PST 2022
	Tue Nov 15 17:44:34 PST 2022
	Tue Nov 15 17:44:36 PST 2022
	Tue Nov 15 17:44:37 PST 2022
	Tue Nov 15 17:44:38 PST 2022
			</pre>
	</section>
  </div>
<div class="panels">
  <div id="left_panel">
    <section id="editor">
      <textarea id="myTextarea">
  // sample code, NOT REAL
  
  var editor = CodeMirror.fromTextArea(myTextarea, {
	  lineNumbers: true,
	  mode: 'text/javascript'
	});
  
	var curr_file = ""
  
	function loadFile(fname) {
		jQuery.get('/read?fname=' + fname).then(function(r) {
			editor.setValue(r.content)
			curr_file = fname
			if (curr_file.endsWith('.py')) {
				editor.setMode('text/python')
			} else if (curr_file.endsWith('.js')) {
				editor.setMode('text/javascript')
			} else if (curr_file.endsWith('.html')) {
				editor.setMode('text/html')
			} else if (curr_file.endsWith('.css')) {
				editor.setMode('text/css')
			}
		})
	}
		  </textarea
      >
    </section>
  </div>
  <section id="file_browser" class="frosted-panel">
  	<div class='hidebutton'>
			<svg
			  xmlns="http://www.w3.org/2000/svg"
			  width="24"
			  height="24"
			  viewBox="0 0 24 24"
			  fill="none"
			  stroke="currentColor"
			  stroke-width="2"
			  stroke-linecap="round"
			  stroke-linejoin="round"
			  class="feather feather-chevron-up"
			>
			  <polyline points="9 0 16 6 9 12"></polyline>
			</svg>
  	</div>
    <ul>
      <li>index.html</li>
      <li>server.py</li>
      <li>modules/getbest.py</li>
      <li>modules/torrents.py</li>
      <li>modules/judy.py</li>
      <li>README.md</li>
    </ul>
  </section>
</div>



<div class="dropContainer">
  <!-- down chevron -->
  <div class="dropDown">
		<svg
		  xmlns="http://www.w3.org/2000/svg"
		  width="24"
		  height="24"
		  viewBox="0 0 24 24"
		  fill="none"
		  stroke="currentColor"
		  stroke-width="2"
		  stroke-linecap="round"
		  stroke-linejoin="round"
		  class="feather feather-chevron-up"
		>
		  <polyline points="18 15 12 9 6 15"></polyline>
		  <!-- <polyline points="0 0 8 9 0 18"></polyline> -->
		</svg>
  </div>
</div>

<style type="text/css">
  body {
    margin: 0;
    padding: 0;
    font-family: sans-serif;
    background-color: #1b2430;
    color: white;
    overflow: hidden;
  }

  pre {
  	color: #AAA;
  }

  section > ul {
  	list-style-type: none;
  	padding-left: 0px;
  	margin-bottom: 5px;
  	margin-top: 5px;
  }
 
  section > ul > li {
    list-style: none;
    padding: 0;
    margin: 0;
    cursor: pointer;
    color: #888;
    font-family: monospace;
    text-shadow: 0px 0px 5px gray;
  }

  section > ul > li .current_file {
  	color: white;
  }

	section > ul > li:hover {
		padding-left: 5px;
	}

	section > ul > li .rm {
		display: none;
	}
	section > ul > li .rm:hover {
		display: inline-block;
	}

  .panels {
    display: flex;
    flex-direction: row;
    height: 100vh;
  }

  #logsPanel {
    position: absolute;
    height: 100vh;
    width: 100vw;
    display: flex;
    flex-direction: column;
    flex: 1;
    bottom: 0;
		justify-content: end;
		margin-left: 50px;
    width: 100vw;
  }

  .CodeMirror-linenumbers {
    color: #aaa;
    background-color: #1b2430;
    padding-right: 5px;
  }

 

  .frosted-panel {
  	border: 3px solid #333333AA;
    border-radius: 5px;
    list-style: none;
    padding: 5px;
    margin: 11px;
    z-index: 10;
    right: 0;
    position: absolute;

    background: rgba(0, 0, 0, 20%) !important;
    /* gaussian blur */
    backdrop-filter: blur(4px);
    z-index: 10;

		box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);

		transition: width 0.5s ease-in-out;
  }

  .frosted-panel.hideme {
  	width: 25px;
		transition: width 0.5s ease-in-out;
  }
  .frosted-panel.hideme ul {
		display: none;
  }

  .frosted-panel .hidebutton {
  	margin-top: 10px;
  	margin-right: 10px;
  	cursor: pointer;
  }

  .CodeMirror {
    height: 85%;
    width: 100%;

    overflow: hidden;

    position: absolute;
    width: 100vw;

    background: rgba(0, 0, 0, 60%) !important;
    /* gaussian blur */
    backdrop-filter: blur(4px);
    z-index: 10;
		transition: height 0.5s ease-in-out;

		box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
		word-break: break-all;
  }

  .CodeMirror.hideme {
		height: 10%;
		transition: height 0.5s ease-in-out;
  }


  .dropContainer {
		position: absolute;
		bottom: 10px;
		
		width: 100vw;
		height: 10vh;
		z-index: 100;
		justify-content: center;
    ALIGN-ITEMS: end;
    display: flex;
    pointer-events: none;
  }
  .dropDown {
		cursor: pointer;
		pointer-events: all;
  }

</style>

<script>
  var editor = CodeMirror.fromTextArea(myTextarea, {
    lineNumbers: true,
		lineWrapping: true,
    mode: "text/javascript",
  });
  editor.setOption("theme", "solarized dark");

  var curr_file = "";
  var first_run = true;

  var fname_prefix ="";

  function loadFile(fname) {
    jQuery.get("/read?fname=" + fname).then(function (r) {
      editor.setValue(r.content);
      curr_file = fname;
      if (curr_file.endsWith(".py")) {
        editor.setOption("mode", "python");
      } else if (curr_file.endsWith(".js")) {
        editor.setOption("mode", "javascript");
      } else if (curr_file.endsWith(".html")) {
        editor.setOption("mode", "htmlmixed");
      } else if (curr_file.endsWith(".css")) {
        editor.setOption("mode", "css");
      } else if (curr_file.endsWith(".sh")) {
        editor.setOption("mode", "shell");
      }
    });
  }

  function refreshFileList(initial) {
    jQuery.get("/files").then(function (r) {
    	// determine what the common fname prefix is
    	if (r.files.length > 0) {
    		var parts = r.files[0].split("/");
    		fname_prefix = ""
    		var test_prefix = ""
    		for (var part of parts) {
    			fname_prefix = test_prefix
    			test_prefix += part + "/"
    			var found_mismatch = false
    			for (var fname of r.files) {
    				if (!fname.startsWith(test_prefix)) {
    					found_mismatch = true
    					break;
    				}
    			}
    			if (found_mismatch) break
    		}
    	}
      var html = "";
      for (var fname of r.files) {
        html += "<li><span class='rm'>‚ùå</span><span class='fname'>./" + fname.replace(fname_prefix, '') + "</span></li>";
      }
      html += "";
      jQuery("#file_browser ul").html(html);
      jQuery("#file_browser ul li .fname").click(function (ev) {
        loadFile(fname_prefix + ev.currentTarget.innerText);
        refreshFileList()
      });
      var curr = jQuery("#file_browser ul li .fname").filter(function(i, e) {
      	return jQuery(e).text() == curr_file.replace(fname_prefix, '');
    	})
    	console.log(curr.toArray())
    	curr.addClass('current_file')
      if (initial) {
      	jQuery('#file_browser li:first .fname').click()
      }
    });
  }
  refreshFileList(true);
  setInterval(refreshFileList, 10000);

  function refreshLogs() {
    jQuery.get("/logs").then(function (r) {
      jQuery("#log pre").html(r.content);
    });
  }
  refreshLogs();
  setInterval(refreshLogs, 1000);

  jQuery(document).keydown(function (event) {
    if ((event.ctrlKey || event.metaKey) && event.which == 83) {
      var code = editor.getValue();
      $.ajax("/save?fname=" + curr_file, {
        data: JSON.stringify({ content: code }),
        contentType: "application/json",
        type: "POST",
      });
      event.preventDefault();
      return false;
    }
  });

  jQuery(".dropDown").click(function (ev) {
		jQuery(".CodeMirror").toggleClass("hideme");
  });

  jQuery(".frosted-panel .hidebutton").click(function (ev) {
		jQuery(".frosted-panel").toggleClass("hideme");
  });
</script>
